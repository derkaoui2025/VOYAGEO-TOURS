<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <%- include('../partials/head') %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <% 
    const getStatusBadgeClass = (status) => {
      switch(status) {
        case 'confirmed': return 'badge-success';
        case 'pending': return 'badge-warning';
        case 'completed': return 'badge-primary';
        case 'cancelled': return 'badge-error';
        default: return 'badge-ghost';
      }
    };
    %>

    <div class="p-4">
        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 class="text-2xl font-bold">Booking Management</h1>
            <div class="flex gap-2">
                <button id="export-csv" class="btn btn-outline btn-sm">
                    <i class="fas fa-file-csv mr-2"></i> Export CSV
                </button>
                <button id="export-excel" class="btn btn-outline btn-sm btn-success">
                    <i class="fas fa-file-excel mr-2"></i> Export Excel
                </button>
            </div>
        </div>
        <!-- back to dashboard   -->
        <a href="/admin/dashboard" class="btn btn-outline btn-sm">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
        
        <!-- Filter Card -->
        <div class="card bg-base-100 shadow-sm mb-6">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-4">Filter Bookings</h2>
                <form id="filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Status</span>
                        </label>
                        <select id="status" name="status" class="select select-bordered w-full">
                            <option value="">All Statuses</option>
                            <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="confirmed" <%= filters.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                            <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Search</span>
                        </label>
                        <input type="text" id="search" name="search" value="<%= filters.search %>" placeholder="Search by name or email" class="input input-bordered w-full">
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Start Date</span>
                        </label>
                        <input type="date" id="startDate" name="startDate" value="<%= filters.startDate %>" class="input input-bordered w-full">
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">End Date</span>
                        </label>
                        <input type="date" id="endDate" name="endDate" value="<%= filters.endDate %>" class="input input-bordered w-full">
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-4 flex justify-end gap-2 mt-2">
                        <button type="button" id="clear-filters" class="btn btn-ghost">Clear</button>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="card bg-base-100 shadow-sm mb-6 overflow-x-auto">
            <div class="card-body p-0">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Guest</th>
                            <th>Tour</th>
                            <th>Date</th>
                            <th>Guests</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (bookings && bookings.length > 0) { %>
                            <% bookings.forEach(booking => { %>
                                <tr>
                                    <td>
                                        <div class="font-medium"><%= booking.fullName %></div>
                                        <div class="text-xs opacity-70"><%= booking.email %></div>
                                    </td>
                                    <td>
                                        <% if (booking.tourSlug) { %>
                                            <a href="/tours/<%= booking.tourSlug %>" target="_blank" class="link link-primary">
                                                <%= booking.tourName %>
                                            </a>
                                        <% } else { %>
                                            <%= booking.tourName %>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div><%= new Date(booking.tourDate).toLocaleDateString() %></div>
                                        <div class="text-xs opacity-70">
                                            Booked: <%= new Date(booking.createdAt).toLocaleDateString() %>
                                        </div>
                                    </td>
                                    <td><%= booking.guestCount %></td>
                                    <td class="font-medium">$<%= booking.totalPrice.toFixed(2) %></td>
                                    <td>
                                        <div class="badge <%= getStatusBadgeClass(booking.status) %>">
                                            <%= booking.status.charAt(0).toUpperCase() + booking.status.slice(1) %>
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <div class="flex justify-end gap-2">
                                            <a href="/admin/bookings/<%= booking._id %>" class="btn btn-ghost btn-sm btn-square">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button 
                                                data-booking-id="<%= booking._id %>" 
                                                class="btn btn-ghost btn-sm btn-square text-error delete-booking">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="text-center py-8 opacity-70">
                                    <div class="flex flex-col items-center gap-2">
                                        <i class="fas fa-search text-2xl"></i>
                                        <span>No bookings found matching your criteria.</span>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <% if (pagination.totalPages > 1) { %>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-6">
                <div class="text-sm opacity-70">
                    Showing <span class="font-medium"><%= ((pagination.currentPage - 1) * 10) + 1 %></span> to 
                    <span class="font-medium"><%= Math.min(pagination.currentPage * 10, pagination.totalItems) %></span> of 
                    <span class="font-medium"><%= pagination.totalItems %></span> bookings
                </div>
                <div class="join">
                    <% if (pagination.hasPrevPage) { %>
                        <a href="?page=<%= pagination.currentPage - 1 %>&status=<%= filters.status %>&search=<%= filters.search %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>" 
                            class="join-item btn btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    <% } else { %>
                        <button disabled class="join-item btn btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    <% } %>
                    
                    <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                        <% if (i === pagination.currentPage) { %>
                            <button class="join-item btn btn-sm btn-active"><%= i %></button>
                        <% } else if (
                            i === 1 || 
                            i === pagination.totalPages || 
                            (i >= pagination.currentPage - 1 && i <= pagination.currentPage + 1)
                        ) { %>
                            <a href="?page=<%= i %>&status=<%= filters.status %>&search=<%= filters.search %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>" 
                                class="join-item btn btn-sm"><%= i %></a>
                        <% } else if (
                            i === pagination.currentPage - 2 || 
                            i === pagination.currentPage + 2
                        ) { %>
                            <button class="join-item btn btn-sm btn-disabled">...</button>
                        <% } %>
                    <% } %>
                    
                    <% if (pagination.hasNextPage) { %>
                        <a href="?page=<%= pagination.currentPage + 1 %>&status=<%= filters.status %>&search=<%= filters.search %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>" 
                            class="join-item btn btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    <% } else { %>
                        <button disabled class="join-item btn btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    <% } %>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Delete Confirmation Modal -->
    <dialog id="delete-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Confirm Deletion</h3>
            <p class="py-4">Are you sure you want to delete this booking? This action cannot be undone.</p>
            <div class="modal-action">
                <button id="cancel-delete" class="btn">Cancel</button>
                <button id="confirm-delete" class="btn btn-error">Delete</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Clear filters
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.getElementById('status').value = '';
                document.getElementById('search').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('filter-form').submit();
            });

            // Delete booking functionality
            const deleteModal = document.getElementById('delete-modal');
            const cancelDelete = document.getElementById('cancel-delete');
            const confirmDelete = document.getElementById('confirm-delete');
            let bookingToDelete = null;

            // Show modal for delete confirmation
            document.querySelectorAll('.delete-booking').forEach(button => {
                button.addEventListener('click', function() {
                    bookingToDelete = this.dataset.bookingId;
                    deleteModal.showModal();
                });
            });

            // Hide modal when cancel is clicked
            cancelDelete.addEventListener('click', function() {
                deleteModal.close();
                bookingToDelete = null;
            });

            // Handle delete confirmation
            confirmDelete.addEventListener('click', function() {
                if (bookingToDelete) {
                    window.location.href = `/admin/bookings/${bookingToDelete}/delete`;
                }
            });

            // Export CSV
            document.getElementById('export-csv').addEventListener('click', function() {
                const params = new URLSearchParams(window.location.search);
                window.location.href = `/admin/bookings/export/csv?${params.toString()}`;
            });

            // Export Excel
            document.getElementById('export-excel').addEventListener('click', function() {
                const params = new URLSearchParams(window.location.search);
                window.location.href = `/admin/bookings/export/excel?${params.toString()}`;
            });
        });
    </script>
</body>
</html> 