<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <%- include('../partials/head') %>
</head>
<body>
    <div class="p-4">
        <div class="mb-6">
            <a href="/admin/bookings" class="btn btn-ghost btn-sm gap-2">
                <i class="fas fa-arrow-left"></i> Back to Bookings
            </a>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold">Booking Details</h1>
            
            <button id="delete-booking-btn" class="btn btn-error btn-sm gap-2">
                <i class="fas fa-trash"></i> Delete Booking
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Main Booking Details -->
            <div class="md:col-span-2 space-y-6">
                <!-- Guest Information Card -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <h2 class="card-title">Guest Information</h2>
                            
                            <!-- Status dropdown -->
                            <div class="flex items-center gap-2">
                                <span class="text-sm opacity-70">Status:</span>
                                <select id="booking-status" class="select select-bordered select-sm">
                                    <option value="pending" <%= booking.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                    <option value="confirmed" <%= booking.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                                    <option value="completed" <%= booking.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                    <option value="cancelled" <%= booking.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="divider my-2"></div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Name</span>
                                    </label>
                                    <p><%= booking.fullName %></p>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text font-medium">Email</span>
                                    </label>
                                    <p><%= booking.email %></p>
                                </div>
                            </div>
                            <div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Tour Date</span>
                                    </label>
                                    <p><%= new Date(booking.tourDate).toLocaleDateString() %></p>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text font-medium">Number of Guests</span>
                                    </label>
                                    <p><%= booking.guestCount %></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-control mt-4">
                            <label class="label">
                                <span class="label-text font-medium">Special Requests</span>
                            </label>
                            <p><%= booking.specialRequests || 'None' %></p>
                        </div>
                    </div>
                </div>
                
                <!-- Tour Information Card -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title">Tour Information</h2>
                        
                        <div class="divider my-2"></div>
                        
                        <% if (booking.tourId) { %>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text font-medium">Tour Name</span>
                                        </label>
                                        <p>
                                            <a href="/tours/<%= booking.tourId.slug %>" target="_blank" class="link link-primary">
                                                <%= booking.tourId.title %>
                                            </a>
                                        </p>
                                    </div>
                                    <div class="form-control mt-4">
                                        <label class="label">
                                            <span class="label-text font-medium">Duration</span>
                                        </label>
                                        <p><%= booking.tourId.duration %> days</p>
                                    </div>
                                </div>
                                <div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text font-medium">Tour Price</span>
                                        </label>
                                        <p>$<%= booking.tourId.price.toFixed(2) %> per person</p>
                                    </div>
                                    <div class="form-control mt-4">
                                        <label class="label">
                                            <span class="label-text font-medium">Total Price</span>
                                        </label>
                                        <p class="text-xl text-primary font-bold">$<%= booking.totalPrice.toFixed(2) %></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-control mt-4">
                                <label class="label">
                                    <span class="label-text font-medium">Tour Description</span>
                                </label>
                                <p class="text-sm opacity-80"><%= booking.tourId.description %></p>
                            </div>
                        <% } else { %>
                            <div class="alert alert-error">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Tour information not available</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Booking Summary Sidebar -->
            <div class="md:col-span-1 space-y-6">
                <!-- Booking Summary Card -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title">Booking Summary</h2>
                        
                        <div class="divider my-2"></div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Booking Date</span>
                            </label>
                            <p><%= new Date(booking.createdAt).toLocaleDateString() %></p>
                        </div>
                        
                        <div class="form-control mt-4">
                            <label class="label">
                                <span class="label-text font-medium">Booking ID</span>
                            </label>
                            <p class="text-xs opacity-70 break-all"><%= booking._id %></p>
                        </div>
                        
                        <div class="divider my-3">Price Breakdown</div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70">Tour Price:</span>
                            <span>$<%= (booking.totalPrice / booking.guestCount).toFixed(2) %> Ã— <%= booking.guestCount %></span>
                        </div>
                        
                        <div class="flex justify-between items-center font-bold text-lg mt-4">
                            <span>Total:</span>
                            <span class="text-primary">$<%= booking.totalPrice.toFixed(2) %></span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions Card -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title">Actions</h2>
                        
                        <div class="divider my-2"></div>
                        
                        <div class="space-y-3">
                            <button id="send-confirmation-email" class="btn btn-primary btn-block">
                                <i class="fas fa-envelope mr-2"></i> Send Confirmation
                            </button>
                            
                            <button id="send-reminder-email" class="btn btn-block">
                                <i class="fas fa-bell mr-2"></i> Send Reminder
                            </button>
                            
                            <% if (booking.status === 'cancelled') { %>
                                <button id="restore-booking" class="btn btn-warning btn-block">
                                    <i class="fas fa-undo mr-2"></i> Restore Booking
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <dialog id="delete-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Confirm Deletion</h3>
            <p class="py-4">Are you sure you want to delete this booking? This action cannot be undone.</p>
            <div class="modal-action">
                <button id="cancel-delete" class="btn">Cancel</button>
                <button id="confirm-delete" class="btn btn-error">Delete</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Email Preview Modal -->
    <dialog id="email-modal" class="modal">
        <div class="modal-box max-w-3xl">
            <h3 class="font-bold text-lg" id="email-modal-title">Email Preview</h3>
            <div id="email-preview" class="border rounded-box p-4 bg-base-200 my-4">
                <!-- Email content will be inserted here -->
            </div>
            <div class="modal-action">
                <button id="cancel-email" class="btn">Cancel</button>
                <button id="send-email" class="btn btn-primary">Send Email</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update booking status
            const statusSelect = document.getElementById('booking-status');
            let originalStatus = statusSelect.value;
            
            statusSelect.addEventListener('change', function() {
                const newStatus = this.value;
                
                // Update status via API
                fetch(`/admin/bookings/<%= booking._id %>/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        originalStatus = newStatus;
                        
                        // Show success toast
                        const toast = document.createElement('div');
                        toast.className = 'toast toast-top toast-end';
                        toast.innerHTML = `
                            <div class="alert alert-success">
                                <span>Booking status updated successfully</span>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        
                        // Remove toast after 3 seconds
                        setTimeout(() => {
                            toast.remove();
                        }, 3000);
                    } else {
                        // Show error toast
                        const toast = document.createElement('div');
                        toast.className = 'toast toast-top toast-end';
                        toast.innerHTML = `
                            <div class="alert alert-error">
                                <span>${data.message || 'Failed to update booking status'}</span>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        
                        // Remove toast after 3 seconds
                        setTimeout(() => {
                            toast.remove();
                        }, 3000);
                        
                        // Revert to original status
                        statusSelect.value = originalStatus;
                    }
                });
            });
            
            // Delete booking
            const deleteModal = document.getElementById('delete-modal');
            const deleteButton = document.getElementById('delete-booking-btn');
            const cancelDelete = document.getElementById('cancel-delete');
            const confirmDelete = document.getElementById('confirm-delete');
            
            deleteButton.addEventListener('click', function() {
                deleteModal.showModal();
            });
            
            cancelDelete.addEventListener('click', function() {
                deleteModal.close();
            });
            
            confirmDelete.addEventListener('click', function() {
                window.location.href = `/admin/bookings/<%= booking._id %>/delete`;
            });
            
            // Email modal functionality
            const emailModal = document.getElementById('email-modal');
            const emailPreview = document.getElementById('email-preview');
            const emailTitle = document.getElementById('email-modal-title');
            const cancelEmail = document.getElementById('cancel-email');
            const sendEmail = document.getElementById('send-email');
            let emailType = '';
            
            document.getElementById('send-confirmation-email').addEventListener('click', function() {
                emailType = 'confirmation';
                emailTitle.textContent = 'Confirmation Email Preview';
                
                // Fetch email preview
                fetch(`/admin/bookings/<%= booking._id %>/email-preview?type=confirmation`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            emailPreview.innerHTML = data.html;
                            emailModal.showModal();
                        } else {
                            alert(data.message || 'Failed to generate email preview');
                        }
                    });
            });
            
            document.getElementById('send-reminder-email').addEventListener('click', function() {
                emailType = 'reminder';
                emailTitle.textContent = 'Reminder Email Preview';
                
                // Fetch email preview
                fetch(`/admin/bookings/<%= booking._id %>/email-preview?type=reminder`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            emailPreview.innerHTML = data.html;
                            emailModal.showModal();
                        } else {
                            alert(data.message || 'Failed to generate email preview');
                        }
                    });
            });
            
            cancelEmail.addEventListener('click', function() {
                emailModal.close();
            });
            
            sendEmail.addEventListener('click', function() {
                // Send email
                fetch(`/admin/bookings/<%= booking._id %>/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: emailType })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        emailModal.close();
                        
                        // Show success toast
                        const toast = document.createElement('div');
                        toast.className = 'toast toast-top toast-end';
                        toast.innerHTML = `
                            <div class="alert alert-success">
                                <span>Email sent successfully</span>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        
                        // Remove toast after 3 seconds
                        setTimeout(() => {
                            toast.remove();
                        }, 3000);
                    } else {
                        alert(data.message || 'Failed to send email');
                    }
                });
            });
            
            // Restore booking
            if (document.getElementById('restore-booking')) {
                document.getElementById('restore-booking').addEventListener('click', function() {
                    if (confirm('Are you sure you want to restore this booking?')) {
                        fetch(`/admin/bookings/<%= booking._id %>/restore`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.reload();
                            } else {
                                alert(data.message || 'Failed to restore booking');
                            }
                        });
                    }
                });
            }
        });
    </script>
</body>
</html> 